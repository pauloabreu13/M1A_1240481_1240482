pipeline {
    agent any // Use any available agent for the pipeline

    environment {
        MAVEN_HOME = 'C:\\Dev\\apache-maven-3.9.9'
        JAVA_HOME = 'C:\\Java\\openlogic-openjdk-17.0.12+7-windows-x64'

        GITHUB_URL = 'https://github.com/pedrojcoliveira/M1A_1240481_1240482.git'
        GITHUB_BRANCH = 'main'
    }

    stages {

        stage('Checkout') {
            steps {
                git url: "${GITHUB_URL}", branch: "${GITHUB_BRANCH}"
            }
        }

        stage('Clean') {
            steps {
                // Run the Maven clean command to clean the project
                bat "${MAVEN_HOME}\\bin\\mvn clean"
            }
        }

        stage('Validate') {
            steps {
                // Run the Maven validate command to validate the project
                bat "${MAVEN_HOME}\\bin\\mvn validate"
            }
        }

        stage('Compile') {
            steps {
                // Run the Maven compile command to compile the project
                bat "${MAVEN_HOME}\\bin\\mvn compile"
            }
        }

        /*stage('Test') {
            steps {
                // Run the Maven test command to test the project
                bat "${MAVEN_HOME}\\bin\\mvn test"
            }
        }*/

        stage('Package') {
            steps {
                // Run the Maven package command to package the project
                bat "${MAVEN_HOME}\\bin\\mvn package -DskipTests"
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('SonarQube') {
                    bat '''mvn sonar:sonar -Dsonar.projectKey=SonarQubeToken -Dsonar.projectName='SonarQube' -Dsonar.host.url=http://localhost:9000'''
                    echo 'SonarQube Analysis Completed'
                }
            }
        }

        stage('Deploy') {
            steps {
                // Run the Maven deploy command to deploy the project and save to the target folder inside the project
                bat "${MAVEN_HOME}\\bin\\mvn deploy -DaltDeploymentRepository=local::default::file:${WORKSPACE}\\target"

            }
        }

        stage('Run Application') {
            steps {
                // Run the Java application using the compiled JAR file
                echo "Running the Java application..."
                bat "java -jar ${WORKSPACE}\\target\\psoft-g1-0.0.1-SNAPSHOT.jar --server.port=2228"
            }
        }

    }
}